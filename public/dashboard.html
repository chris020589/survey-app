<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>問卷總覽</title>
  <style>
    .survey-item {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
    }
    .survey-actions {
      margin-top: 10px;
    }
    .survey-actions button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>問卷總覽</h1>
  
  <!-- 新增問卷按鈕 -->
  <button onclick="goToNewSurvey()">新增問卷</button>
  
  <div id="surveyList"></div>
  
  <script>
    const API_URL = 'http://localhost:5000/api/surveys';

    // 跳轉到 new.html
    function goToNewSurvey() {
      window.location.href = 'new.html';
    }

    // 獲取問卷列表
    async function fetchSurveys() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('請先登入');
          window.location.href = 'login.html'; // 跳轉到登入頁面
          return;
        }

        const res = await fetch(API_URL, {
          headers: {
            'Authorization': `Bearer ${token}`,
            //'Content-Type': 'application/json',
            //'Accept': 'application/json'
          }
        });

        if (!res.ok) {
          throw new Error('無法獲取問卷列表');
        }

        const data = await res.json();
      
        const surveyList = document.getElementById('surveyList');
        surveyList.innerHTML = '';
      
        if (data.message) {
          // 沒有問卷
          surveyList.innerHTML = `<p>${data.message}</p>`;
          return;
        }

        // 如果問卷列表為空，顯示提示
        if (Array.isArray(data) && data.length === 0) {
          alert('您目前沒有任何問卷，請先去新增問卷');
          window.location.href = 'new.html';
          return;
        }
      
        data.forEach(survey => {
          surveyList.innerHTML += `
            <div class="survey-item">
              <h3>${survey.title}</h3>
              <p>${survey.description}</p>
              <div class="survey-actions">
                <button onclick="viewResults('${survey._id}')">查看結果</button>
                <button onclick="editSurvey('${survey._id}')">編輯問卷</button>
                <button onclick="deleteSurvey('${survey._id}')">刪除問卷</button>
              </div>
            </div>
          `;
        });
      } catch (err) {
      console.error('獲取問卷失敗:', err);
      alert('載入問卷列表失敗，請稍後再試');
      }
    }
  
    // 編輯問卷
    function editSurvey(surveyId) {
      console.log('編輯問卷:', surveyId);
      // 將問卷 ID 存入 localStorage，以便在 new.html 中獲取
      localStorage.setItem('editingSurveyId', surveyId);
      // 跳轉到 new.html
      window.location.href = 'new.html?edit=true';
    }

    // 查看結果
    function viewResults(surveyId) {
      loadStats(surveyId);
    }

    // 刪除問卷
    async function deleteSurvey(surveyId) {
      const confirmDelete = confirm('確定要刪除此問卷嗎？此操作無法復原！');
      if (!confirmDelete) {
        return; // 如果使用者取消，則不執行刪除
      }

      const token = localStorage.getItem('token');
      if (!token) {
        alert('請先登入！');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/${surveyId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        if (res.ok) {
          alert('問卷已成功刪除！');
          // 刪除成功後重新載入問卷列表
          fetchSurveys();
        } else {
          const error = await res.json();
          alert(`刪除問卷失敗！原因：${error.error || '未知錯誤'}`);
        }
      } catch (err) {
        console.error('刪除問卷時發生錯誤:', err);
        alert('伺服器錯誤，請稍後再試');
      }
    }

    // 載入統計數據
    async function loadStats(surveyId) {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_URL}/${surveyId}/stats`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            //'Content-Type': 'application/json',
            //'Accept': 'application/json'
          }
        });

        if (!res.ok) {
          throw new Error('無法獲取統計數據');
        }

        const stats = await res.json();
        alert(JSON.stringify(stats)); // 可以改為更友好的顯示方式
      } catch (err) {
        console.error(err);
        alert('載入統計數據失敗，請稍後再試');
      }
    }

    // 頁面載入時獲取問卷列表
    document.addEventListener('DOMContentLoaded', fetchSurveys);
  </script>
</body>
</html>